#ifndef MAINWINDOW_H
#define MAINWINDOW_H

#include <QMainWindow>

#include <QProgressDialog>

#include <visa.h> // include VISA header file
#include "typedefs.h" // required by sparams.cpp...

namespace Ui {
class MainWindow;
}

class MainWindow : public QMainWindow
{
    Q_OBJECT

public:
    explicit MainWindow(QWidget *parent = nullptr);
    ~MainWindow();

private slots:
    void on_pushButtonGPIBINFO_clicked();

    void on_pushButtonSnP_FORM4_clicked();
    void on_pushButtonSnP_FORM1_clicked();

    void on_pushButtonFORM1_clicked();

    void on_pushButtonPRESET_clicked();

    void on_pushButtonFORM4_clicked();

    void on_pushButtonFORM5_clicked();

    void on_pushButton_STIMULUS_READ_clicked();

    void on_pushButton_START_STOP_WRITE_clicked();

    void on_pushButton_CENTER_SPAN_WRITE_clicked();

    void on_pushButton_NB_POINTS_WRITE_clicked();

    void on_pushButton_OpenCaptureDir_clicked();

private:
    void readSettings();
    void writeSettings();

    bool instrument_setup(ViSession instr);

    bool read_complex_trace_FORM4(QProgressDialog *progress,
                            ViSession instr,
                            C8             *param,
                            C8             *query,
                            COMPLEX_DOUBLE *dest,
                            S32             cnt,
                            S32             progress_fraction);
    bool save_SnP_FORM4(QProgressDialog *progress,
                  ViSession instr,
                  S32       SnP,
                  C8       *param,
                  C8       *query,
                  DOUBLE    R_ohms,
                  const C8 *data_format,
                  const C8 *freq_format,
                  S32       DC_entry,
                  const C8 *explicit_filename);

    bool read_complex_trace_FORM1(QProgressDialog *progress,
                            ViSession instr,
                            C8             *param,
                            C8             *query,
                            COMPLEX_DOUBLE *dest,
                            S32             cnt,
                            S32             progress_fraction);
    bool save_SnP_FORM1(QProgressDialog *progress,
                  ViSession instr,
                  S32       SnP,
                  C8       *param,
                  C8       *query,
                  DOUBLE    R_ohms,
                  const C8 *data_format,
                  const C8 *freq_format,
                  S32       DC_entry,
                  const C8 *explicit_filename);

    C8 instrument_name[512];
    C8 instrument_opts[128]; // OUTPOPTS => ASCII Options
    C8 instrument_if_bandwidth[48]; // IFBW? => "IF bandwidth: %.lf Hz"
    C8 instrument_smoothing[16]; // SMOOO? => "Smoothing ON" or "Smoothing OFF"
    C8 instrument_averaging[16]; // AVERO? => "Averaging ON" or "Averaging OFF"
    C8 instrument_correction[16]; // CORR? => "Correction ON" or "Correction OFF"
    C8 instrument_out_power_level[48]; // POWE? => "Output power level: %.6lf dBm"
    //bool debug_mode = TRUE;
    bool debug_mode = FALSE;

    QString savefile_path;

    Ui::MainWindow *ui;
};

const char VISA_GPIB_RES_STR[]= { "GPIB0::16::INSTR" };

#define SETTINGS_FILENAME "VNA_Qt.ini"

#define MHZ_VAL (1000000)

// FORM1 data format see http://www.vnahelp.com/tip23.html
typedef struct form1_raw_imag_real
{
    unsigned char imag_msb; /* imaginary mantissa */
    unsigned char imag_lsb;

    unsigned char real_msb; /* real mantissa */
    unsigned char real_lsb;

    unsigned char unused; /* additional resolution (imag/real) not used */
    unsigned char common_exp; /* common exponent */
} t_form1_raw_imag_real;

/* Pre-computed pow(2, E) table for pow_2_E with E = 8bits signed */
const double pow_2_exp_tab[256] =
{
    1.0,                                                                                // 0  0
    2.0,                                                                                // 1  1
    4.0,                                                                                // 2  2
    8.0,                                                                                // 3  3
    16.0,                                                                               // 4  4
    32.0,                                                                               // 5  5
    64.0,                                                                               // 6  6
    128.0,                                                                              // 7  7
    256.0,                                                                              // 8  8
    512.0,                                                                              // 9  9
    1024.0,                                                                             // A  10
    2048.0,                                                                             // B  11
    4096.0,                                                                             // C  12
    8192.0,                                                                             // D  13
    16384.0,                                                                            // E  14
    32768.0,                                                                            // F  15
    65536.0,                                                                            // 10 16
    131072.0,                                                                           // 11 17
    262144.0,                                                                           // 12 18
    524288.0,                                                                           // 13 19
    1048576.0,                                                                          // 14 20
    2097152.0,                                                                          // 15 21
    4194304.0,                                                                          // 16 22
    8388608.0,                                                                          // 17 23
    16777216.0,                                                                         // 18 24
    33554432.0,                                                                         // 19 25
    67108864.0,                                                                         // 1A 26
    134217728.0,                                                                        // 1B 27
    268435456.0,                                                                        // 1C 28
    536870912.0,                                                                        // 1D 29
    1073741824.0,                                                                       // 1E 30
    2147483648.0,                                                                       // 1F 31
    4294967296.0,                                                                       // 20 32
    8589934592.0,                                                                       // 21 33
    17179869184.0,                                                                      // 22 34
    34359738368.0,                                                                      // 23 35
    68719476736.0,                                                                      // 24 36
    137438953472.0,                                                                     // 25 37
    274877906944.0,                                                                     // 26 38
    549755813888.0,                                                                     // 27 39
    1099511627776.0,                                                                    // 28 40
    2199023255552.0,                                                                    // 29 41
    4398046511104.0,                                                                    // 2A 42
    8796093022208.0,                                                                    // 2B 43
    17592186044416.0,                                                                   // 2C 44
    35184372088832.0,                                                                   // 2D 45
    70368744177664.0,                                                                   // 2E 46
    140737488355328.0,                                                                  // 2F 47
    281474976710656.0,                                                                  // 30 48
    562949953421312.0,                                                                  // 31 49
    1125899906842624.0,                                                                 // 32 50
    2251799813685248.0,                                                                 // 33 51
    4503599627370496.0,                                                                 // 34 52
    9007199254740992.0,                                                                 // 35 53
    18014398509481984.0,                                                                // 36 54
    36028797018963968.0,                                                                // 37 55
    72057594037927936.0,                                                                // 38 56
    144115188075855872.0,                                                               // 39 57
    288230376151711744.0,                                                               // 3A 58
    576460752303423488.0,                                                               // 3B 59
    1152921504606846976.0,                                                              // 3C 60
    2305843009213693952.0,                                                              // 3D 61
    4611686018427387904.0,                                                              // 3E 62
    9223372036854775808.0,                                                              // 3F 63
    18446744073709551616.0,                                                             // 40 64
    36893488147419103232.0,                                                             // 41 65
    73786976294838206464.0,                                                             // 42 66
    147573952589676412928.0,                                                            // 43 67
    295147905179352825856.0,                                                            // 44 68
    590295810358705651712.0,                                                            // 45 69
    1180591620717411303424.0,                                                           // 46 70
    2361183241434822606848.0,                                                           // 47 71
    4722366482869645213696.0,                                                           // 48 72
    9444732965739290427392.0,                                                           // 49 73
    18889465931478580854784.0,                                                          // 4A 74
    37778931862957161709568.0,                                                          // 4B 75
    75557863725914323419136.0,                                                          // 4C 76
    151115727451828646838272.0,                                                         // 4D 77
    302231454903657293676544.0,                                                         // 4E 78
    604462909807314587353088.0,                                                         // 4F 79
    1208925819614629174706176.0,                                                        // 50 80
    2417851639229258349412352.0,                                                        // 51 81
    4835703278458516698824704.0,                                                        // 52 82
    9671406556917033397649408.0,                                                        // 53 83
    19342813113834066795298816.0,                                                       // 54 84
    38685626227668133590597632.0,                                                       // 55 85
    77371252455336267181195264.0,                                                       // 56 86
    154742504910672534362390528.0,                                                      // 57 87
    309485009821345068724781056.0,                                                      // 58 88
    618970019642690137449562112.0,                                                      // 59 89
    1237940039285380274899124224.0,                                                     // 5A 90
    2475880078570760549798248448.0,                                                     // 5B 91
    4951760157141521099596496896.0,                                                     // 5C 92
    9903520314283042199192993792.0,                                                     // 5D 93
    19807040628566084398385987584.0,                                                    // 5E 94
    39614081257132168796771975168.0,                                                    // 5F 95
    79228162514264337593543950336.0,                                                    // 60 96
    158456325028528675187087900672.0,                                                   // 61 97
    316912650057057350374175801344.0,                                                   // 62 98
    633825300114114700748351602688.0,                                                   // 63 99
    1267650600228229401496703205376.0,                                                  // 64 100
    2535301200456458802993406410752.0,                                                  // 65 101
    5070602400912917605986812821504.0,                                                  // 66 102
    10141204801825835211973625643008.0,                                                 // 67 103
    20282409603651670423947251286016.0,                                                 // 68 104
    40564819207303340847894502572032.0,                                                 // 69 105
    81129638414606681695789005144064.0,                                                 // 6A 106
    162259276829213363391578010288128.0,                                                // 6B 107
    324518553658426726783156020576256.0,                                                // 6C 108
    649037107316853453566312041152512.0,                                                // 6D 109
    1298074214633706907132624082305024.0,                                               // 6E 110
    2596148429267413814265248164610048.0,                                               // 6F 111
    5192296858534827628530496329220096.0,                                               // 70 112
    10384593717069655257060992658440192.0,                                              // 71 113
    20769187434139310514121985316880384.0,                                              // 72 114
    41538374868278621028243970633760768.0,                                              // 73 115
    83076749736557242056487941267521536.0,                                              // 74 116
    166153499473114484112975882535043072.0,                                             // 75 117
    332306998946228968225951765070086144.0,                                             // 76 118
    664613997892457936451903530140172288.0,                                             // 77 119
    1329227995784915872903807060280344576.0,                                            // 78 120
    2658455991569831745807614120560689152.0,                                            // 79 121
    5316911983139663491615228241121378304.0,                                            // 7A 122
    10633823966279326983230456482242756608.0,                                           // 7B 123
    21267647932558653966460912964485513216.0,                                           // 7C 124
    42535295865117307932921825928971026432.0,                                           // 7D 125
    85070591730234615865843651857942052864.0,                                           // 7E 126
    170141183460469231731687303715884105728.0,                                          // 7F 127
    0.00000000000000000000000000000000000000293873587705571876992184134305561419454666, // 80 128 -128
    0.00000000000000000000000000000000000000587747175411143753984368268611122838909333, // 81 129 -127
    0.00000000000000000000000000000000000001175494350822287507968736537222245677818666, // 82 130 -126
    0.00000000000000000000000000000000000002350988701644575015937473074444491355637331, // 83 131 -125
    0.00000000000000000000000000000000000004701977403289150031874946148888982711274662, // 84 132 -124
    0.00000000000000000000000000000000000009403954806578300063749892297777965422549324, // 85 133 -123
    0.00000000000000000000000000000000000018807909613156600127499784595555930845098649, // 86 134 -122
    0.00000000000000000000000000000000000037615819226313200254999569191111861690197298, // 87 135 -121
    0.00000000000000000000000000000000000075231638452626400509999138382223723380394596, // 88 136 -120
    0.00000000000000000000000000000000000150463276905252801019998276764447446760789191, // 89 137 -119
    0.00000000000000000000000000000000000300926553810505602039996553528894893521578383, // 8A 138 -118
    0.00000000000000000000000000000000000601853107621011204079993107057789787043156765, // 8B 139 -117
    0.00000000000000000000000000000000001203706215242022408159986214115579574086313530, // 8C 140 -116
    0.00000000000000000000000000000000002407412430484044816319972428231159148172627060, // 8D 141 -115
    0.00000000000000000000000000000000004814824860968089632639944856462318296345254121, // 8E 142 -114
    0.00000000000000000000000000000000009629649721936179265279889712924636592690508241, // 8F 143 -113
    0.00000000000000000000000000000000019259299443872358530559779425849273185381016482, // 90 144 -112
    0.00000000000000000000000000000000038518598887744717061119558851698546370762032964, // 91 145 -111
    0.00000000000000000000000000000000077037197775489434122239117703397092741524065929, // 92 146 -110
    0.00000000000000000000000000000000154074395550978868244478235406794185483048131857, // 93 147 -109
    0.00000000000000000000000000000000308148791101957736488956470813588370966096263714, // 94 148 -108
    0.00000000000000000000000000000000616297582203915472977912941627176741932192527429, // 95 149 -107
    0.00000000000000000000000000000001232595164407830945955825883254353483864385054858, // 96 150 -106
    0.00000000000000000000000000000002465190328815661891911651766508706967728770109716, // 97 151 -105
    0.00000000000000000000000000000004930380657631323783823303533017413935457540219431, // 98 152 -104
    0.00000000000000000000000000000009860761315262647567646607066034827870915080438863, // 99 153 -103
    0.00000000000000000000000000000019721522630525295135293214132069655741830160877726, // 9A 154 -102
    0.00000000000000000000000000000039443045261050590270586428264139311483660321755451, // 9B 155 -101
    0.00000000000000000000000000000078886090522101180541172856528278622967320643510902, // 9C 156 -100
    0.00000000000000000000000000000157772181044202361082345713056557245934641287021805, // 9D 157 -99
    0.00000000000000000000000000000315544362088404722164691426113114491869282574043609, // 9E 158 -98
    0.00000000000000000000000000000631088724176809444329382852226228983738565148087218, // 9F 159 -97
    0.00000000000000000000000000001262177448353618888658765704452457967477130296174437, // A0 160 -96
    0.00000000000000000000000000002524354896707237777317531408904915934954260592348874, // A1 161 -95
    0.00000000000000000000000000005048709793414475554635062817809831869908521184697747, // A2 162 -94
    0.00000000000000000000000000010097419586828951109270125635619663739817042369395494, // A3 163 -93
    0.00000000000000000000000000020194839173657902218540251271239327479634084738790989, // A4 164 -92
    0.00000000000000000000000000040389678347315804437080502542478654959268169477581978, // A5 165 -91
    0.00000000000000000000000000080779356694631608874161005084957309918536338955163956, // A6 166 -90
    0.00000000000000000000000000161558713389263217748322010169914619837072677910327911, // A7 167 -89
    0.00000000000000000000000000323117426778526435496644020339829239674145355820655823, // A8 168 -88
    0.00000000000000000000000000646234853557052870993288040679658479348290711641311646, // A9 169 -87
    0.00000000000000000000000001292469707114105741986576081359316958696581423282623291, // AA 170 -86
    0.00000000000000000000000002584939414228211483973152162718633917393162846565246582, // AB 171 -85
    0.00000000000000000000000005169878828456422967946304325437267834786325693130493164, // AC 172 -84
    0.00000000000000000000000010339757656912845935892608650874535669572651386260986328, // AD 173 -83
    0.00000000000000000000000020679515313825691871785217301749071339145302772521972656, // AE 174 -82
    0.00000000000000000000000041359030627651383743570434603498142678290605545043945312, // AF 175 -81
    0.00000000000000000000000082718061255302767487140869206996285356581211090087890625, // B0 176 -80
    0.00000000000000000000000165436122510605534974281738413992570713162422180175781250, // B1 177 -79
    0.00000000000000000000000330872245021211069948563476827985141426324844360351562500, // B2 178 -78
    0.00000000000000000000000661744490042422139897126953655970282852649688720703125000, // B3 179 -77
    0.00000000000000000000001323488980084844279794253907311940565705299377441406250000, // B4 180 -76
    0.00000000000000000000002646977960169688559588507814623881131410598754882812500000, // B5 181 -75
    0.00000000000000000000005293955920339377119177015629247762262821197509765625000000, // B6 182 -74
    0.00000000000000000000010587911840678754238354031258495524525642395019531250000000, // B7 183 -73
    0.00000000000000000000021175823681357508476708062516991049051284790039062500000000, // B8 184 -72
    0.00000000000000000000042351647362715016953416125033982098102569580078125000000000, // B9 185 -71
    0.00000000000000000000084703294725430033906832250067964196205139160156250000000000, // BA 186 -70
    0.00000000000000000000169406589450860067813664500135928392410278320312500000000000, // BB 187 -69
    0.00000000000000000000338813178901720135627329000271856784820556640625000000000000, // BC 188 -68
    0.00000000000000000000677626357803440271254658000543713569641113281250000000000000, // BD 189 -67
    0.00000000000000000001355252715606880542509316001087427139282226562500000000000000, // BE 190 -66
    0.00000000000000000002710505431213761085018632002174854278564453125000000000000000, // BF 191 -65
    0.00000000000000000005421010862427522170037264004349708557128906250000000000000000, // C0 192 -64
    0.00000000000000000010842021724855044340074528008699417114257812500000000000000000, // C1 193 -63
    0.00000000000000000021684043449710088680149056017398834228515625000000000000000000, // C2 194 -62
    0.00000000000000000043368086899420177360298112034797668457031250000000000000000000, // C3 195 -61
    0.00000000000000000086736173798840354720596224069595336914062500000000000000000000, // C4 196 -60
    0.00000000000000000173472347597680709441192448139190673828125000000000000000000000, // C5 197 -59
    0.00000000000000000346944695195361418882384896278381347656250000000000000000000000, // C6 198 -58
    0.00000000000000000693889390390722837764769792556762695312500000000000000000000000, // C7 199 -57
    0.00000000000000001387778780781445675529539585113525390625000000000000000000000000, // C8 200 -56
    0.00000000000000002775557561562891351059079170227050781250000000000000000000000000, // C9 201 -55
    0.00000000000000005551115123125782702118158340454101562500000000000000000000000000, // CA 202 -54
    0.00000000000000011102230246251565404236316680908203125000000000000000000000000000, // CB 203 -53
    0.00000000000000022204460492503130808472633361816406250000000000000000000000000000, // CC 204 -52
    0.00000000000000044408920985006261616945266723632812500000000000000000000000000000, // CD 205 -51
    0.00000000000000088817841970012523233890533447265625000000000000000000000000000000, // CE 206 -50
    0.00000000000000177635683940025046467781066894531250000000000000000000000000000000, // CF 207 -49
    0.00000000000000355271367880050092935562133789062500000000000000000000000000000000, // D0 208 -48
    0.00000000000000710542735760100185871124267578125000000000000000000000000000000000, // D1 209 -47
    0.00000000000001421085471520200371742248535156250000000000000000000000000000000000, // D2 210 -46
    0.00000000000002842170943040400743484497070312500000000000000000000000000000000000, // D3 211 -45
    0.00000000000005684341886080801486968994140625000000000000000000000000000000000000, // D4 212 -44
    0.00000000000011368683772161602973937988281250000000000000000000000000000000000000, // D5 213 -43
    0.00000000000022737367544323205947875976562500000000000000000000000000000000000000, // D6 214 -42
    0.00000000000045474735088646411895751953125000000000000000000000000000000000000000, // D7 215 -41
    0.00000000000090949470177292823791503906250000000000000000000000000000000000000000, // D8 216 -40
    0.00000000000181898940354585647583007812500000000000000000000000000000000000000000, // D9 217 -39
    0.00000000000363797880709171295166015625000000000000000000000000000000000000000000, // DA 218 -38
    0.00000000000727595761418342590332031250000000000000000000000000000000000000000000, // DB 219 -37
    0.00000000001455191522836685180664062500000000000000000000000000000000000000000000, // DC 220 -36
    0.00000000002910383045673370361328125000000000000000000000000000000000000000000000, // DD 221 -35
    0.00000000005820766091346740722656250000000000000000000000000000000000000000000000, // DE 222 -34
    0.00000000011641532182693481445312500000000000000000000000000000000000000000000000, // DF 223 -33
    0.00000000023283064365386962890625000000000000000000000000000000000000000000000000, // E0 224 -32
    0.00000000046566128730773925781250000000000000000000000000000000000000000000000000, // E1 225 -31
    0.00000000093132257461547851562500000000000000000000000000000000000000000000000000, // E2 226 -30
    0.00000000186264514923095703125000000000000000000000000000000000000000000000000000, // E3 227 -29
    0.00000000372529029846191406250000000000000000000000000000000000000000000000000000, // E4 228 -28
    0.00000000745058059692382812500000000000000000000000000000000000000000000000000000, // E5 229 -27
    0.00000001490116119384765625000000000000000000000000000000000000000000000000000000, // E6 230 -26
    0.00000002980232238769531250000000000000000000000000000000000000000000000000000000, // E7 231 -25
    0.00000005960464477539062500000000000000000000000000000000000000000000000000000000, // E8 232 -24
    0.00000011920928955078125000000000000000000000000000000000000000000000000000000000, // E9 233 -23
    0.00000023841857910156250000000000000000000000000000000000000000000000000000000000, // EA 234 -22
    0.00000047683715820312500000000000000000000000000000000000000000000000000000000000, // EB 235 -21
    0.00000095367431640625000000000000000000000000000000000000000000000000000000000000, // EC 236 -20
    0.00000190734863281250000000000000000000000000000000000000000000000000000000000000, // ED 237 -19
    0.00000381469726562500000000000000000000000000000000000000000000000000000000000000, // EE 238 -18
    0.00000762939453125000000000000000000000000000000000000000000000000000000000000000, // EF 239 -17
    0.00001525878906250000000000000000000000000000000000000000000000000000000000000000, // F0 240 -16
    0.00003051757812500000000000000000000000000000000000000000000000000000000000000000, // F1 241 -15
    0.00006103515625000000000000000000000000000000000000000000000000000000000000000000, // F2 242 -14
    0.00012207031250000000000000000000000000000000000000000000000000000000000000000000, // F3 243 -13
    0.00024414062500000000000000000000000000000000000000000000000000000000000000000000, // F4 244 -12
    0.00048828125000000000000000000000000000000000000000000000000000000000000000000000, // F5 245 -11
    0.00097656250000000000000000000000000000000000000000000000000000000000000000000000, // F6 246 -10
    0.00195312500000000000000000000000000000000000000000000000000000000000000000000000, // F7 247 -9
    0.00390625000000000000000000000000000000000000000000000000000000000000000000000000, // F8 248 -8
    0.00781250000000000000000000000000000000000000000000000000000000000000000000000000, // F9 249 -7
    0.01562500000000000000000000000000000000000000000000000000000000000000000000000000, // FA 250 -6
    0.03125000000000000000000000000000000000000000000000000000000000000000000000000000, // FB 251 -5
    0.06250000000000000000000000000000000000000000000000000000000000000000000000000000, // FC 252 -4
    0.12500000000000000000000000000000000000000000000000000000000000000000000000000000, // FD 253 -3
    0.25000000000000000000000000000000000000000000000000000000000000000000000000000000, // FE 254 -2
    0.50000000000000000000000000000000000000000000000000000000000000000000000000000000  // FF 255 -1
};

#endif // MAINWINDOW_H
